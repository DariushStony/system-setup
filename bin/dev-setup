#!/usr/bin/env bash
set -euo pipefail

########################################
# Dev Setup - CLI Tool
# Cross-platform development environment setup
########################################

VERSION="1.0.0"
BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT_DIR="$(cd "$BIN_DIR/.." && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Colors
BLUE='\033[1;34m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
NC='\033[0m'

log() { printf "${BLUE}[INFO]${NC} %s\n" "$1"; }
success() { printf "${GREEN}[âœ“]${NC} %s\n" "$1"; }
warn() { printf "${YELLOW}[WARN]${NC} %s\n" "$1"; }
error() { printf "${RED}[ERROR]${NC} %s\n" "$1" >&2; exit 1; }

########################################
# CLI Commands
########################################

cmd_install() {
    log "Running installation..."
    cd "$SCRIPT_DIR"
    "$LIB_DIR/bootstrap.sh" "$@"
}

cmd_update() {
    log "Updating packages..."
    cd "$SCRIPT_DIR"
    "$LIB_DIR/update.sh" "$@"
}

cmd_select() {
    log "Package selection..."
    cd "$SCRIPT_DIR"
    "$LIB_DIR/select-packages.sh" "$@"
}

cmd_check() {
    log "Checking package status..."
    cd "$SCRIPT_DIR"
    if [ -f "$SCRIPT_DIR/Makefile" ]; then
        make check
    else
        warn "Makefile not found"
    fi
}

cmd_list() {
    echo ""
    echo "ðŸ“¦ Available Packages"
    echo ""
    
    if [ -f "$SCRIPT_DIR/.package-categories" ]; then
        source "$SCRIPT_DIR/.package-categories"
        
        echo "Current selection:"
        echo ""
        [ "$INSTALL_ESSENTIALS" = "true" ] && success "Essential tools" || echo "[ ] Essential tools"
        [ "$INSTALL_LANGUAGES" = "true" ] && success "Programming languages" || echo "[ ] Programming languages"
        [ "$INSTALL_DEV_TOOLS" = "true" ] && success "Development tools" || echo "[ ] Development tools"
        [ "$INSTALL_BROWSERS" = "true" ] && success "Browsers" || echo "[ ] Browsers"
        [ "$INSTALL_EDITORS" = "true" ] && success "Editors & IDEs" || echo "[ ] Editors & IDEs"
        [ "$INSTALL_COMMUNICATION" = "true" ] && success "Communication" || echo "[ ] Communication"
        [ "$INSTALL_PRODUCTIVITY" = "true" ] && success "Productivity" || echo "[ ] Productivity"
        [ "$INSTALL_MEDIA" = "true" ] && success "Media" || echo "[ ] Media"
        [ "$INSTALL_WINDOW_MANAGERS" = "true" ] && success "Window managers" || echo "[ ] Window managers"
        [ "$INSTALL_FONTS" = "true" ] && success "Fonts" || echo "[ ] Fonts"
        [ "$INSTALL_ZSH_PLUGINS" = "true" ] && success "Zsh plugins" || echo "[ ] Zsh plugins"
        [ "$INSTALL_OPTIONAL" = "true" ] && success "Optional tools" || echo "[ ] Optional tools"
    else
        warn "No package selection found"
        echo "Run: dev-setup select"
    fi
    echo ""
}

cmd_config() {
    local config_file="$HOME/.dev-setup-config"
    
    if [ ! -f "$config_file" ]; then
        warn "No configuration found at $config_file"
        echo "Run 'dev-setup install' first to create configuration"
        exit 1
    fi
    
    if [ "${1:-}" = "edit" ]; then
        ${EDITOR:-vim} "$config_file"
        success "Configuration edited"
    elif [ "${1:-}" = "show" ]; then
        cat "$config_file"
    elif [ "${1:-}" = "reset" ]; then
        rm -f "$config_file"
        rm -f "$SCRIPT_DIR/.package-categories"
        success "Configuration reset"
    else
        echo "Configuration location: $config_file"
        echo ""
        echo "Commands:"
        echo "  dev-setup config show   - Show configuration"
        echo "  dev-setup config edit   - Edit configuration"
        echo "  dev-setup config reset  - Reset configuration"
    fi
}

cmd_doctor() {
    echo ""
    echo "ðŸ¥ System Check"
    echo ""
    
    # Check OS
    case "$(uname -s)" in
        Darwin*) OS="macOS" ;;
        Linux*) OS="Linux" ;;
        *) OS="Unknown" ;;
    esac
    success "OS: $OS"
    
    # Check required tools
    command -v git >/dev/null 2>&1 && success "git installed" || warn "git NOT installed"
    command -v curl >/dev/null 2>&1 && success "curl installed" || warn "curl NOT installed"
    
    # Check platform-specific tools
    if [ "$OS" = "macOS" ]; then
        command -v brew >/dev/null 2>&1 && success "Homebrew installed" || warn "Homebrew NOT installed"
    elif [ "$OS" = "Linux" ]; then
        command -v apt >/dev/null 2>&1 && success "apt available" || echo "[ ] apt not available"
        command -v dnf >/dev/null 2>&1 && success "dnf available" || echo "[ ] dnf not available"
    fi
    
    # Check config
    [ -f "$HOME/.dev-setup-config" ] && success "Config file exists" || echo "[ ] No config file"
    [ -f "$SCRIPT_DIR/.package-categories" ] && success "Package selection exists" || echo "[ ] No package selection"
    
    echo ""
}

cmd_clean() {
    log "Cleaning up temporary files..."
    cd "$SCRIPT_DIR"
    if [ -f "$SCRIPT_DIR/Makefile" ]; then
        make clean
    else
        rm -f "$SCRIPT_DIR/.dev-setup-config.tmp"
        rm -f "$SCRIPT_DIR/.package-categories.backup"
    fi
    success "Cleanup complete"
}

cmd_uninstall() {
    echo ""
    warn "This will uninstall the dev-setup CLI tool"
    read -p "Are you sure? [y/N] " answer
    
    case $answer in
        [Yy]*)
            local install_dir="/usr/local/bin"
            
            if [ -L "$install_dir/dev-setup" ] || [ -f "$install_dir/dev-setup" ]; then
                sudo rm "$install_dir/dev-setup"
                success "CLI tool uninstalled from $install_dir"
            else
                warn "CLI tool not found in $install_dir"
            fi
            
            echo ""
            log "Note: Installed packages are NOT removed"
            log "Configuration files kept: ~/.dev-setup-config"
            log "Project directory remains: $SCRIPT_DIR"
            echo ""
            ;;
        *)
            log "Uninstall canceled"
            ;;
    esac
}

########################################
# Help
########################################

show_help() {
    cat << EOF

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       dev-setup CLI Tool v${VERSION}       â•‘
â•‘   Cross-Platform Development Setup     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USAGE:
  dev-setup <command> [options]

COMMANDS:
  install [options]     Install development environment
                        Options: --minimal, --full, --dry-run
  
  select [preset]       Choose packages to install
                        Presets: --minimal, --developer, --full
  
  update               Update all installed packages
  
  list                 List available packages and selection
  
  check                Check installation status
  
  config               Manage configuration
    show               Show current configuration
    edit               Edit configuration file
    reset              Reset all configuration
  
  doctor               Check system and dependencies
  
  clean                Clean up temporary files
  
  uninstall            Uninstall dev-setup CLI tool
  
  version              Show version
  
  help                 Show this help

EXAMPLES:
  # Interactive installation
  dev-setup install
  
  # Choose packages first
  dev-setup select
  dev-setup install
  
  # Quick presets
  dev-setup select --minimal
  dev-setup install --dry-run
  
  # Maintenance
  dev-setup update
  dev-setup check
  dev-setup doctor
  
  # Configuration
  dev-setup list
  dev-setup config show
  
MORE INFO:
  Documentation: $SCRIPT_DIR/README.md
  Issues: https://github.com/username/dev-setup/issues

EOF
}

show_version() {
    echo "dev-setup version $VERSION"
}

########################################
# Main
########################################

main() {
    local cmd="${1:-}"
    
    case "$cmd" in
        install)
            shift
            cmd_install "$@"
            ;;
        update)
            shift
            cmd_update "$@"
            ;;
        select)
            shift
            cmd_select "$@"
            ;;
        check)
            cmd_check
            ;;
        list|ls)
            cmd_list
            ;;
        config)
            shift
            cmd_config "$@"
            ;;
        doctor)
            cmd_doctor
            ;;
        clean)
            cmd_clean
            ;;
        uninstall)
            cmd_uninstall
            ;;
        version|-v|--version)
            show_version
            ;;
        help|-h|--help|"")
            show_help
            ;;
        *)
            error "Unknown command: $cmd\n\nRun 'dev-setup help' for usage"
            ;;
    esac
}

main "$@"

